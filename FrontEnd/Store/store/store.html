<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="C·ª≠a h√†ng game tr·ª±c tuy·∫øn v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng cho game th·ªß">
    <title>Store - C·ª≠a h√†ng game</title>
    <link rel="stylesheet" href="../css/store.css">
    <link rel="icon" type="image/png" sizes="96x96" href="../../Home/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../../Home/favicon/web-app-manifest-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../../Home/favicon/web-app-manifest-512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../Home/favicon/apple-touch-icon.png">
    <link rel="manifest" href="../../Home/favicon/site.webmanifest">
</head>
<body>
    <header>
        <div class="header-container">
            <a href="../../Home/home/home.html">
                <img src="../../Home/img/logo.png" alt="Logo" class="logo">
            </a>
            <h1>Game Store</h1>
            <div class="cart-icon" onclick="openCart()">
                üõí <span id="cart-count">0</span>
            </div>
            <div class="menu-icon">‚ò∞</div>
        </div>
    </header>
    
    <main>
        <section class="products" id="product-list">
            <div class="loading">ƒêang t·∫£i s·∫£n ph·∫©m...</div>
        </section>
        
        <!-- Shopping Cart Modal -->
        <div id="shopping-cart-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeCartModal()">&times;</span>
                <h2>Gi·ªè h√†ng</h2>
                <div id="cart-items"></div>
                <div id="cart-total"></div>
                
                <div class="payment-methods">
                    <h3>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n:</h3>
                    <div class="payment-options">
                        <label>
                            <input type="radio" name="payment" value="cash" checked>
                            <span class="payment-icon">üíµ</span>
                            Thanh to√°n ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng
                        </label>
                        <label>
                            <input type="radio" name="payment" value="banking">
                            <span class="payment-icon">üè¶</span>
                            Chuy·ªÉn kho·∫£n ng√¢n h√†ng
                        </label>
                        <label>
                            <input type="radio" name="payment" value="momo">
                            <span class="payment-icon">üì±</span>
                            V√≠ ƒëi·ªán t·ª≠ MoMo
                        </label>
                    </div>
                    
                    <div class="shipping-info">
                        <h3>Th√¥ng tin giao h√†ng:</h3>
                        <div class="error-message" style="display: none; color: #ff4444; margin-bottom: 10px;"></div>
                        <input type="text" id="fullname" placeholder="H·ªç v√† t√™n" required>
                        <input type="tel" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required>
                        <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ giao h√†ng" required>
                        <textarea id="note" placeholder="Ghi ch√∫ ƒë∆°n h√†ng (n·∫øu c√≥)"></textarea>
                    </div>
                </div>

                <button onclick="checkout()" id="checkout-button">Thanh to√°n</button>
            </div>
        </div>
    </main>
    
    <script src="../../config/api.js"></script>
    <script>
        let cart = [];
        let currentOrder = null;

        // Load products when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
        });

        async function loadProducts() {
            try {
                const productList = document.getElementById("product-list");
                if (!productList) {
                    console.error("Product list element not found");
                    return;
                }

                // S·ª≠ d·ª•ng products ƒë√£ ƒë·ªãnh nghƒ©a ·ªü tr√™n
                window.products = [
                    {
                        id: 1,
                        name: "Gaming Mouse G502",
                        description: "Chu·ªôt gaming cao c·∫•p v·ªõi RGB v√† DPI t√πy ch·ªânh",
                        price: 500000,
                        image: "gaming-mouse.webp",
                        stock: 10
                    },
                    {
                        id: 2, 
                        name: "Mechanical Keyboard K100",
                        description: "B√†n ph√≠m c∆° chuy√™n game v·ªõi switch Cherry MX",
                        price: 1200000,
                        image: "gaming-keyboard.avif",
                        stock: 5
                    },
                    {
                        id: 3,
                        name: "Gaming Headset Cloud II",  
                        description: "Tai nghe 7.1 v·ªõi micro kh·ª≠ ti·∫øng ·ªìn",
                        price: 800000,
                        image: "gaming-headset.jpg",
                        stock: 8
                    },
                    {
                        id: 4,
                        name: "Gaming Chair DXRacer",
                        description: "Gh·∫ø gaming cao c·∫•p v·ªõi ƒë·ªám √™m √°i", 
                        price: 15500000,
                        image: "gaming-chair.jpg",
                        stock: 3
                    },
                    {
                        id: 5,
                        name: "Gaming Monitor 27\" 165Hz",
                        description: "M√†n h√¨nh gaming 27 inch, 165Hz, 1ms, G-Sync",
                        price: 12000000,
                        image: "gaming-monitor.avif",
                        stock: 6
                    },
                    {
                        id: 6,
                        name: "Gaming Laptop RTX 4070",
                        description: "Laptop gaming v·ªõi RTX 4070, i7, 16GB RAM, 1TB SSD",
                        price: 25000000,
                        image: "gaming-laptop.webp", 
                        stock: 4
                    },
                    {
                        id: 7,
                        name: "Gaming Desk RGB",
                        description: "B√†n gaming cao c·∫•p v·ªõi LED RGB v√† qu·∫£n l√Ω d√¢y c√°p",
                        price: 38800000,
                        image: "gaming-desk.jpg",
                        stock: 7
                    },
                    {
                        id: 8,
                        name: "Ultimate Gaming Bundle", 
                        description: "B·ªô gaming full setup: Chu·ªôt + B√†n ph√≠m + Tai nghe + Mousepad",
                        price: 10000000,
                        image: "gaming-bundle.jpg",
                        stock: 3
                    }
                ];

                productList.innerHTML = window.products.map(product => `
                    <div class="product" data-product-id="${product.id}" data-stock="${product.stock || 10}">
                        <img src="../img/${product.image}" alt="${product.name}">
                        <h2>${product.name}</h2>
                        <p>${product.description}</p>
                        <p class="price">Gi√°: ${product.price.toLocaleString("vi-VN")} VNƒê</p>
                        <input type="number" min="1" max="${product.stock}" value="1" class="quantity" 
                               data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                        <div class="button-container" style="display: flex; gap: 10px; justify-content: center;">
                            <button class="add-to-cart-button ${product.stock <= 0 ? 'out-of-stock' : ''}" 
                                    onclick="addToCart(this)" 
                                    ${product.stock <= 0 ? 'disabled' : ''}>
                                ${product.stock <= 0 ? 'H·∫øt h√†ng' : 'Th√™m v√†o gi·ªè'}
                            </button>
                            <button class="buy-button ${product.stock <= 0 ? 'out-of-stock' : ''}" 
                                    onclick="buyNow(this)" 
                                    ${product.stock <= 0 ? 'disabled' : ''}>
                                ${product.stock <= 0 ? 'H·∫øt h√†ng' : 'Mua ngay'}
                            </button>
                        </div>
                    </div>
                `).join("");
            } catch (error) {
                console.error('Error loading products:', error);
                const productList = document.getElementById("product-list");
                if (productList) {
                    productList.innerHTML = '<div class="error">Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m</div>';
                }
            }
        }

        // Add functions for handling modals
        function closeCartModal() {
            document.getElementById("shopping-cart-modal").style.display = "none";
        }

        function closeModal() {
            document.getElementById("cart-modal").style.display = "none";
        }

        // Add showError function to global scope
        function showError(message) {
            const errorDiv = document.querySelector('.shipping-info .error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Cu·ªôn ƒë·∫øn v·ªã tr√≠ l·ªói
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById("cart-count").textContent = count;
        }

        function openCart() {
            const cartItems = document.getElementById("cart-items");
            const cartTotal = document.getElementById("cart-total");
            let total = 0;

            cartItems.innerHTML = cart.map(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                return `
                    <div class="cart-item">
                        <span>${item.name}</span>
                        <span>${item.quantity} x ${item.price.toLocaleString("vi-VN")} VNƒê</span>
                        <span>${subtotal.toLocaleString("vi-VN")} VNƒê</span>
                        <div class="cart-item-controls">
                            <input type="number" 
                                   value="${item.quantity}" 
                                   min="1" 
                                   max="${window.products.find(p => p.id.toString() === item.productId).stock}"
                                   onchange="updateItemQuantity('${item.productId}', this.value)">
                            <button onclick="removeFromCart('${item.productId}')">X√≥a</button>
                        </div>
                    </div>
                `;
            }).join("");

            cartTotal.innerHTML = `T·ªïng c·ªông: ${total.toLocaleString("vi-VN")} VNƒê`;
            document.getElementById("shopping-cart-modal").style.display = "flex";
            document.getElementById("checkout-button").disabled = cart.length === 0;
        }

        // Th√™m h√†m m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong gi·ªè h√†ng
        function updateItemQuantity(productId, newQuantity) {
            const item = cart.find(item => item.productId === productId);
            const product = window.products.find(p => p.id.toString() === productId);
            
            newQuantity = parseInt(newQuantity);
            
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            if (newQuantity > product.stock) {
                showError('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° h√†ng t·ªìn kho!');
                openCart(); // Refresh cart display
                return;
            }
            
            item.quantity = newQuantity;
            item.total = item.price * newQuantity;
            
            updateCartCount();
            openCart(); // Refresh cart display
        }

        function addToCart(button) {
            const productDiv = button.parentElement.parentElement; // Th√™m .parentElement v√¨ c√≥ th√™m div container
            const quantityInput = productDiv.querySelector(".quantity");
            const quantity = parseInt(quantityInput.value);
            const productId = quantityInput.dataset.id;
            const name = quantityInput.dataset.name;
            const price = parseFloat(quantityInput.dataset.price); // ƒê·ªïi sang parseFloat ƒë·ªÉ x·ª≠ l√Ω s·ªë th·∫≠p ph√¢n
            
            // Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho
            const product = window.products.find(p => p.id.toString() === productId);
            if (!product) {
                showError('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
                return;
            }
            if (product.stock < quantity) {
                showError('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° h√†ng t·ªìn kho!');
                return;
            }

            // Ki·ªÉm tra xem s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity + quantity > product.stock) {
                    showError('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° h√†ng t·ªìn kho!');
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                cart.push({ 
                    productId, 
                    quantity, 
                    name, 
                    price,
                    total: price * quantity // Th√™m t·ªïng ti·ªÅn cho m·ªói item
                });
            }

            updateCartCount();
            showError(`ƒê√£ th√™m ${quantity} ${name} v√†o gi·ªè h√†ng!`);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCartCount();
            openCart(); // C·∫≠p nh·∫≠t l·∫°i hi·ªÉn th·ªã gi·ªè h√†ng
        }

        async function checkout() {
            try {
                const fullname = document.getElementById('fullname').value;
                const phone = document.getElementById('phone').value;
                const address = document.getElementById('address').value;
                const note = document.getElementById('note').value;
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

                // Validate th√¥ng tin
                if (!fullname || !phone || !address) {
                    showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng');
                    return;
                }

                const orderData = {
                    items: cart,
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    shipping: {
                        fullname,
                        phone,
                        address,
                        note
                    },
                    paymentMethod
                };

                // X·ª≠ l√Ω theo ph∆∞∆°ng th·ª©c thanh to√°n
                switch(paymentMethod) {
                    case 'banking':
                        showBankingInfo(orderData);
                        break;
                    case 'momo':
                        showMomoInfo(orderData);
                        break;
                    case 'cash':
                        await processCashPayment(orderData);
                        break;
                }

            } catch (error) {
                showError('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh thanh to√°n');
            }
        }

        function showBankingInfo(orderData) {
            const bankingInfo = `
                <div class="banking-info">
                    <h3>Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
                    <p>Ng√¢n h√†ng: BIDV</p>
                    <p>S·ªë t√†i kho·∫£n: 31410003456789</p>
                    <p>Ch·ªß t√†i kho·∫£n: WARSTORM SHOP</p>
                    <p>S·ªë ti·ªÅn: ${orderData.total.toLocaleString('vi-VN')} VNƒê</p>
                    <p>N·ªôi dung: Thanh toan ${orderData.shipping.phone}</p>
                    <button onclick="confirmBankTransfer('${orderData.shipping.phone}')">
                        T√¥i ƒë√£ chuy·ªÉn kho·∫£n
                    </button>
                </div>
            `;
            document.getElementById('cart-items').innerHTML = bankingInfo;
        }

        function showMomoInfo(orderData) {
            // L∆∞u ƒë∆°n h√†ng hi·ªán t·∫°i
            currentOrder = orderData;
            
            const momoInfo = `
                <div class="payment-info">
                    <h3>Th√¥ng tin thanh to√°n MoMo</h3>
                    <p>S·ªë ƒëi·ªán tho·∫°i: 0987654321</p>
                    <p>Ch·ªß t√†i kho·∫£n: WARSTORM SHOP</p>
                    <p>S·ªë ti·ªÅn: ${orderData.total.toLocaleString('vi-VN')} VNƒê</p>
                    <p>N·ªôi dung: Thanh toan ${orderData.shipping.phone}</p>
                    <button onclick="confirmMomoPayment()">
                        T√¥i ƒë√£ chuy·ªÉn kho·∫£n MoMo
                    </button>
                </div>
            `;
            document.getElementById('cart-items').innerHTML = momoInfo;
        }

        async function confirmMomoPayment() {
            if (currentOrder) {
                await processMomoPayment(currentOrder);
            }
        }

        async function processMomoPayment(orderData) {
            try {
                // Validate th√¥ng tin giao h√†ng
                if (!orderData.shipping.fullname || !orderData.shipping.phone || !orderData.shipping.address) {
                    showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng');
                    return;
                }

                // L∆∞u ƒë∆°n h√†ng v√†o localStorage
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const newOrder = {
                    id: Date.now().toString(),
                    ...orderData,
                    status: 'pending_payment',
                    paymentMethod: 'momo',
                    createdAt: new Date().toISOString()
                };
                orders.push(newOrder);
                localStorage.setItem('orders', JSON.stringify(orders));

                // Gi·∫£ l·∫≠p thanh to√°n MoMo th√†nh c√¥ng
                setTimeout(() => {
                    alert('Thanh to√°n MoMo th√†nh c√¥ng!');
                    completeOrder(orderData);
                }, 1000);
            } catch (error) {
                console.error('Error processing Momo payment:', error);
                showError('L·ªói khi x·ª≠ l√Ω thanh to√°n MoMo');
            }
        }

        async function processCashPayment(orderData) {
            try {
                // Validate th√¥ng tin giao h√†ng
                if (!orderData.shipping.fullname || !orderData.shipping.phone || !orderData.shipping.address) {
                    showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng');
                    return;
                }

                // Ki·ªÉm tra gi·ªè h√†ng
                if (!orderData.items || orderData.items.length === 0) {
                    showError('Gi·ªè h√†ng tr·ªëng');
                    return;
                }

                // L∆∞u ƒë∆°n h√†ng v√†o localStorage
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const newOrder = {
                    id: Date.now().toString(),
                    ...orderData,
                    status: 'pending',
                    paymentMethod: 'cod',
                    createdAt: new Date().toISOString()
                };
                orders.push(newOrder);
                localStorage.setItem('orders', JSON.stringify(orders));

                alert(`ƒê·∫∑t h√†ng th√†nh c√¥ng!\nM√£ ƒë∆°n h√†ng: ${newOrder.id}\nCh√∫ng t√¥i s·∫Ω li√™n h·ªá ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.`);
                completeOrder(orderData);
            } catch (error) {
                console.error('Error processing cash payment:', error);
                showError('L·ªói khi x·ª≠ l√Ω ƒë∆°n h√†ng');
            }
        }

        async function confirmBankTransfer(phone) {
            try {
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const orderIndex = orders.findIndex(order => 
                    order.shipping && order.shipping.phone === phone
                );
                
                if (orderIndex !== -1) {
                    orders[orderIndex].status = 'pending_confirmation';
                    localStorage.setItem('orders', JSON.stringify(orders));
                    alert('C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n! Ch√∫ng t√¥i s·∫Ω x√°c nh·∫≠n sau khi nh·∫≠n ƒë∆∞·ª£c ti·ªÅn.');
                    completeOrder(orders[orderIndex]);
                } else {
                    showError('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng');
                }
            } catch (error) {
                console.error('Error confirming bank transfer:', error);
                showError('L·ªói khi x√°c nh·∫≠n thanh to√°n');
            }
        }

        async function completeOrder(orderData) {
            try {
                cart = [];
                updateCartCount();
                
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
                orderData.items.forEach(item => {
                    const productElement = document.querySelector(`[data-product-id="${item.productId}"]`);
                    if (productElement) {
                        const currentStock = parseInt(productElement.dataset.stock) || 0;
                        const newStock = currentStock - item.quantity;
                        productElement.dataset.stock = newStock;
                        
                        // C·∫≠p nh·∫≠t n√∫t mua h√†ng
                        const buyButton = productElement.querySelector('.buy-button');
                        if (buyButton) {
                            if (newStock <= 0) {
                                buyButton.disabled = true;
                                buyButton.textContent = 'H·∫øt h√†ng';
                                buyButton.classList.add('out-of-stock');
                            }
                        }
                    }
                });

                // Reset form v√† ƒë√≥ng modal
                resetCartModal();
                closeModal();
            } catch (error) {
                console.error('Error completing order:', error);
            }
        }

        function resetCartModal() {
            const cartModal = document.getElementById('cart-modal');
            if (cartModal) {
                cartModal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal()">&times;</span>
                        <h2>X√°c nh·∫≠n mua h√†ng</h2>
                        <div id="cart-items"></div>
                        <div class="shipping-info">
                            <h3>Th√¥ng tin giao h√†ng:</h3>
                            <div class="error-message" style="display: none; color: #ff4444; margin-bottom: 10px;"></div>
                            <input type="text" id="fullname" placeholder="H·ªç v√† t√™n" required>
                            <input type="tel" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required>
                            <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ giao h√†ng" required>
                            <textarea id="note" placeholder="Ghi ch√∫ ƒë∆°n h√†ng (n·∫øu c√≥)"></textarea>
                        </div>
                        <div class="payment-methods">
                            <h3>Ph∆∞∆°ng th·ª©c thanh to√°n:</h3>
                            <label>
                                <input type="radio" name="payment" value="cod" checked>
                                Thanh to√°n khi nh·∫≠n h√†ng (COD)
                            </label>
                            <label>
                                <input type="radio" name="payment" value="banking">
                                Chuy·ªÉn kho·∫£n ng√¢n h√†ng
                            </label>
                            <label>
                                <input type="radio" name="payment" value="momo">
                                V√≠ MoMo
                            </label>
                        </div>
                        <button onclick="checkout()">Thanh to√°n</button>
                    </div>
                `;
            }
        }

        function buyNow(button) {
            addToCart(button);
            openCart();
        }
    </script>
</body>
</html>